{% extends "layouts/base.html" %}
{% block content %}

<!-- Honeypot Manager Header -->
<div class="flex justify-between items-center mb-8">
  <h1 class="text-3xl font-kanit text-accent">Honeypot Manager</h1>
  <a href="{{ url_for('frontend.create_honeypot') }}" class="bg-accent text-secondary px-6 py-2 rounded-md font-kanit text-xl btn-hover-effect transition-all">
    <div class="flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      New Honeypot
    </div>
  </a>
</div>

<!-- Filters Section - Updated to match create_honeypot color scheme -->
<div class="bg-dark-200 rounded-lg p-5 mb-8 text-white border border-dark-400 shadow-dark">
    <h3 class="font-kanit text-2xl mb-5 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        Filters
    </h3>
    <div class="flex flex-col md:flex-row gap-6">
        <!-- Honeypot Type Filter -->
        <div class="flex-1">
            <label for="type-filter" class="block mb-2 text-sm font-semibold">Honeypot Type</label>
            <div class="relative">
                <select id="type-filter" name="type" class="w-full bg-dark-300 border border-dark-400 text-white rounded-md px-4 py-2.5 custom-select focus:border-accent hover:border-accent transition-colors">
                    <option value="">All Types</option>
                    {% for type in honeypot_types %}
                    <option value="{{ type }}" {% if selected_type == type %}selected{% endif %}>{{ type|upper }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Status Filter -->
        <div class="flex-1">
            <label for="status-filter" class="block mb-2 text-sm font-semibold">Status</label>
            <div class="relative">
                <select id="status-filter" name="status" class="w-full bg-dark-300 border border-dark-400 text-white rounded-md px-4 py-2.5 custom-select focus:border-accent hover:border-accent transition-colors">
                    <option value="">All Statuses</option>
                    <option value="created" {% if selected_status == 'created' %}selected{% endif %}>Created</option>
                    <option value="started" {% if selected_status == 'started' %}selected{% endif %}>Started</option>
                    <option value="exited" {% if selected_status == 'exited' %}selected{% endif %}>Exited</option>
                </select>
            </div>
        </div>
        
        <!-- Reset Filters Button -->
        <div class="flex-none flex items-end">
            <button id="reset-filters" class="bg-dark-300 hover:bg-dark-400 hover:text-accent text-white px-4 py-2.5 rounded-md transition-colors flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Reset Filters
            </button>
        </div>
    </div>
</div>

<!-- Honeypot Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="honeypot-grid">
    {% include 'partials/honeypot_cards.html' %}
</div>

<style>
/* Custom Select Styling */
.custom-select {
  appearance: none !important;
  -webkit-appearance: none !important;
  -moz-appearance: none !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") !important;
  background-repeat: no-repeat !important;
  background-position: right 0.75rem center !important;
  background-size: 12px !important;
  padding-right: 2.5rem !important;
  border-width: 1px !important;
  outline: none !important;
}

/* Remove default arrow in IE */
.custom-select::-ms-expand {
  display: none !important;
}

/* Firefox specific fix */
@-moz-document url-prefix() {
  .custom-select {
    text-indent: 0;
    text-overflow: '';
    padding-right: 2.5rem !important;
  }
}

/* Remove Firefox focus ring */
.custom-select:-moz-focusring {
  color: transparent !important;
  text-shadow: 0 0 0 #ffffff !important;
}

/* Override focus styles to only change border color without glow/double lines */
.custom-select:focus {
  border-color: #FF3D4C !important;
  box-shadow: none !important;
  outline: none !important;
}

/* Hover effect for select boxes */
.custom-select:hover {
  border-color: #FF3D4C !important;
}

/* Selected state styling */
.custom-select option:checked {
  background-color: #FF3D4C !important;
  color: white !important;
}

/* Reset button hover effect */
#reset-filters:hover {
  border-color: #FF3D4C !important;
}

/* When reset button is hovered, change the color of the SVG icon too */
#reset-filters:hover svg {
  stroke: #FF3D4C !important;
}
</style>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const typeFilter = document.getElementById('type-filter');
        const statusFilter = document.getElementById('status-filter');
        
        // Apply filters when changed
        function applyFilters() {
            const typeValue = typeFilter.value;
            const statusValue = statusFilter.value;
            
            // Build query params and navigate
            const params = new URLSearchParams();
            if (typeValue) params.append('type', typeValue);
            if (statusValue) params.append('status', statusValue);
            
            window.location.href = '/honeypot_manager?' + params.toString();
        }
        
        if (typeFilter) typeFilter.addEventListener('change', applyFilters);
        if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        
        // Reset filters button
        document.getElementById('reset-filters').addEventListener('click', function() {
            window.location.href = '/honeypot_manager';
        });
        
        // Set to track active requests to prevent duplicate submissions
        const activeRequests = new Set();
        
        // API request handler with error handling
        async function apiRequest(url, method = 'GET', data = null) {
            // Check if request is already in progress
            if (activeRequests.has(url)) {
                console.log('Request already in progress:', url);
                return null;
            }
            
            try {
                // Mark this URL as having an active request
                activeRequests.add(url);
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                const responseData = await response.json();
                
                if (!response.ok) {
                    throw new Error(responseData.detail || `API error: ${response.status}`);
                }
                
                return responseData;
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
                throw error; // Re-throw for further handling if needed
            } finally {
                // Clean up the active request regardless of success/failure
                setTimeout(() => {
                    activeRequests.delete(url);
                }, 1000); // Keep the lock for 1 second to prevent rapid re-clicks
            }
        }
        
        // Perform honeypot actions (start, stop, restart, delete)
        async function performAction(honeypotName, action) {
            // Create a unique request identifier for this action
            const requestUrl = `/api/honeypot/${honeypotName}/${action === 'delete' ? '' : action}`;
            
            try {
                // Show loading notification
                let actionVerb;
                if (action === 'start') {
                    actionVerb = 'Starting';
                } else if (action === 'stop') {
                    actionVerb = 'Stopping';
                } else if (action === 'restart') {
                    actionVerb = 'Restarting';
                } else if (action === 'delete') {
                    actionVerb = 'Deleting';
                }
                
                showNotification(`${actionVerb} honeypot...`, 'info');
                
                // Disable all action buttons for this honeypot to prevent double-clicking
                disableHoneypotButtons(honeypotName);
                
                if (action === 'delete') {
                    await apiRequest(`/api/honeypot/${honeypotName}`, 'DELETE');
                    showNotification(`Honeypot "${honeypotName}" deleted successfully`, 'success');
                } else {
                    await apiRequest(`/api/honeypot/${honeypotName}/${action}`, 'POST');
                    
                    // Use correct past tense form
                    let pastAction;
                    if (action === 'start') {
                        pastAction = 'started';
                    } else if (action === 'stop') {
                        pastAction = 'stopped';
                    } else if (action === 'restart') {
                        pastAction = 'restarted';
                    }
                    
                    showNotification(`Honeypot "${honeypotName}" ${pastAction} successfully`, 'success');
                }
                
                // Immediately refresh the honeypot cards without full page reload
                refreshHoneypots();
                
            } catch (error) {
                console.error(`Failed to ${action} honeypot:`, error);
                // Re-enable buttons if the action failed
                enableHoneypotButtons();
            }
        }
        
        // Disable all buttons for a specific honeypot
        function disableHoneypotButtons(honeypotName) {
            const buttons = document.querySelectorAll(`button[data-honeypot-name="${honeypotName}"]`);
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }
        
        // Re-enable all honeypot buttons
        function enableHoneypotButtons() {
            const buttons = document.querySelectorAll('.button-glow');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }
        
        // New function to refresh honeypot cards without reloading the page
        async function refreshHoneypots() {
            try {
                // Get current filter values
                const typeValue = typeFilter?.value || '';
                const statusValue = statusFilter?.value || '';
                
                // Build query params
                const params = new URLSearchParams();
                if (typeValue) params.append('type', typeValue);
                if (statusValue) params.append('status', statusValue);
                
                // Fetch the updated honeypot cards HTML
                const response = await fetch(`/honeypot_cards?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Failed to refresh honeypots: ${response.status}`);
                }
                
                const html = await response.text();
                const cardsContainer = document.querySelector('#honeypot-grid');
                if (cardsContainer) {
                    cardsContainer.innerHTML = html;
                    
                    // Reattach event listeners to new buttons
                    attachEventListenersToButtons();
                }
            } catch (error) {
                console.error('Error refreshing honeypots:', error);
                // Fall back to page reload if AJAX refresh fails
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        }
        
        // Function to attach event listeners to honeypot action buttons
        function attachEventListenersToButtons() {
            // Attach event listeners to all action buttons
            document.querySelectorAll('.start-honeypot').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    performAction(this.dataset.honeypotName, 'start');
                });
            });
            
            document.querySelectorAll('.stop-honeypot').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    performAction(this.dataset.honeypotName, 'stop');
                });
            });
            
            document.querySelectorAll('.restart-honeypot').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    performAction(this.dataset.honeypotName, 'restart');
                });
            });
            
            document.querySelectorAll('.delete-honeypot').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    if (confirm(`Are you sure you want to delete ${this.dataset.honeypotName}?`)) {
                        performAction(this.dataset.honeypotName, 'delete');
                    }
                });
            });
        }
        
        // Initialize event listeners
        attachEventListenersToButtons();
    });
</script>
{% endblock %}
